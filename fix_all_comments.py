#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
直接修复所有乱码注释
"""

import os
import re

# GameRole.cpp的注释修复
game_role_fixes = [
    (r'/\*锟斤拷锟皆硷拷锟斤拷锟斤拷锟斤拷锟斤拷200锟斤拷息\*/', '/*给自己发送对方的200消息*/'),
    (r'/\*锟斤拷锟斤拷锟斤拷锟揭凤拷锟皆硷拷锟斤拷200锟斤拷息\*/', '/*给对方发送自己的200消息*/'),
    (r'/\*锟斤拷锟皆硷拷锟斤拷锟斤拷锟斤拷锟斤拷201锟斤拷息\*/', '/*给自己发送对方的201消息*/'),
    (r'/\*锟斤拷锟斤拷锟斤拷锟揭凤拷锟皆硷拷锟斤拷201锟斤拷息\*/', '/*给对方发送自己的201消息*/'),
    (r'/\*锟斤拷锟斤拷一锟铰ｏ拷锟斤拷锟斤拷锟斤拷锟斤拷锟斤拷锟斤拷为test\*/', '/*初始化一下，将用户名设置为test（已废弃，现在使用随机姓名）*/'),
    (r'/\*锟斤拷锟斤拷锟斤拷业某锟绞嘉伙拷锟\*/', '/*设置玩家的初始位置*/'),
    (r'/\*通锟斤拷锟斤拷锟斤拷通锟斤拷锟斤拷id锟斤拷锟斤拷唯一锟斤拷\*/', '/*通过协议通道的id作为唯一标识*/'),
    (r'/\*锟斤拷锟斤拷锟斤拷业锟斤拷锟较凤拷锟斤拷锟\*/', '/*将玩家添加到游戏世界*/'),
    (r'/\*锟矫伙拷锟斤拷锟斤拷时锟斤拷要锟斤拷锟矫伙拷锟斤拷锟斤拷锟斤拷息锟斤拷 ID 锟斤拷锟斤拷 锟斤拷\*/', '/*用户登录时需要给用户发送登录信息：ID 名字*/'),
    (r'/\*锟矫伙拷锟斤拷锟竭猴拷锟斤拷要锟斤拷锟戒发锟斤拷锟斤拷围锟斤拷业锟斤拷锟较\*/', '/*用户上线后需要给他发送周围玩家的信息*/'),
    (r'/\*锟斤拷锟斤拷围锟斤拷曳锟斤拷透锟斤拷锟斤拷锟皆硷拷锟斤拷位锟斤拷\*/', '/*给周围玩家发送自己的位置*/'),
    (r'/\*锟斤拷式锟斤拷锟斤拷息\*/', '/*格式化消息*/'),
    (r'/\*取锟斤拷锟斤拷息\*/', '/*获取消息*/'),
    (r'/\*锟斤拷锟斤拷锟斤拷锟斤拷锟斤拷锟较\*/', '/*处理聊天内容消息*/'),
    (r'/\*取锟斤拷锟斤拷锟斤拷锟斤拷锟斤拷\*/', '/*获取聊天内容*/'),
    (r'/\*取锟斤拷锟斤拷锟斤拷锟斤拷锟斤拷锟斤拷锟斤拷锟斤拷\*/', '/*获取所有在线玩家*/'),
    (r'/\*锟斤拷锟斤拷曳锟斤拷锟斤拷锟较\*/', '/*给玩家发送消息*/'),
    (r'/\*锟斤拷锟斤拷锟斤拷锟斤拷锟狡讹拷锟斤拷息\*/', '/*处理玩家移动消息*/'),
    (r'/\*锟斤拷锟斤拷锟斤拷锟斤拷诘锟酵硷拷锟斤拷锟斤拷械锟轿伙拷锟\*/', '/*获取玩家在地图世界中的位置*/'),
    (r'/\*摘锟斤拷锟缴革拷锟斤拷,锟斤拷锟斤拷锟斤拷锟斤拷,锟斤拷锟斤拷锟铰革拷锟接ｏ拷锟斤拷取锟斤拷锟节撅拷s2\*/', '/*摘掉旧格子，更新位置，加入新格子，获取新邻居s2*/'),
    (r'/\*锟斤拷锟斤拷s2锟斤拷锟斤拷元锟截诧拷锟斤拷锟斤拷s1, 锟斤拷野锟斤拷锟斤拷\*/', '/*遍历s2中元素不在s1中，视野出现*/'),
    (r'//锟斤拷野锟斤拷锟斤拷', '//视野出现'),
    (r'/\*锟斤拷锟斤拷s1锟斤拷锟斤拷元锟截诧拷锟斤拷锟斤拷s2锟斤拷锟斤拷野锟斤拷失\*/', '/*遍历s1中元素不在s2中，视野消失*/'),
    (r'//锟斤拷野锟斤拷失', '//视野消失'),
    (r'/\*锟斤拷锟斤拷锟斤拷围锟斤拷曳锟斤拷锟斤拷锟较\*/', '/*给周围玩家发送位置信息*/'),
    (r'/\*锟斤拷锟揭锟斤拷锟酵的憋拷锟斤拷\*/', '/*获取要发送的位置*/'),
    (r'/\*锟斤拷锟截革拷锟斤拷锟斤拷息锟斤拷指锟斤拷\*/', '/*设置位置消息的指针*/'),
    (r'/\*锟斤拷锟斤拷锟斤拷息\*/', '/*发送消息*/'),
    (r'/\*锟节讹拷锟斤拷涌锟斤拷锟斤拷摘锟斤拷锟斤拷时锟斤拷锟绞癸拷锟\*/', '/*在通道接口摘除时会被使用*/'),
    (r'/\*锟斤拷锟斤拷围锟斤拷曳锟斤拷透锟斤拷锟斤拷锟斤拷锟竭碉拷锟斤拷息\*/', '/*给周围玩家发送该玩家下线的消息*/'),
    (r'/\*锟斤拷锟斤拷锟斤拷业锟铰硷拷锟斤拷锟较\*/', '/*创建玩家登录消息*/'),
    (r'/\*锟斤拷锟戒发锟斤拷锟斤拷围锟斤拷业锟斤拷锟较\*/', '/*发送给周围玩家的信息*/'),
    (r'/\*锟斤拷围锟斤拷锟斤拷堑锟斤拷锟较\*/', '/*周围玩家的信息*/'),
    (r'/\*锟斤拷锟斤拷锟轿э拷锟斤拷\*/', '/*获取周围玩家*/'),
    (r'/\*锟斤拷锟斤拷锟斤拷围锟斤拷业锟斤拷锟较锟斤拷surplayers锟斤拷,锟斤拷锟斤拷锟斤拷指锟斤拷锟斤拷锟斤拷息锟斤拷指锟斤拷\*/', '/*添加周围玩家的信息到surplayers中，添加指针指向消息的指针*/'),
    (r'/\*single锟斤拷锟斤拷锟斤拷锟角革拷锟斤拷锟斤拷锟酵ｏ拷锟斤拷锟斤拷锟斤拷要强锟斤拷转锟斤拷锟斤拷锟斤拷锟斤拷\*/', '/*single指向的是Player类型，所以需要强制转换为GameRole*/'),
    (r'/\*锟斤拷锟斤拷锟斤拷锟斤拷息锟斤拷锟斤拷息\*/', '/*设置玩家消息的信息*/'),
    (r'/\*锟斤拷锟斤拷息锟斤拷锟斤拷示锟斤拷围锟斤拷业锟轿伙拷锟\*/', '/*消息中显示周围玩家的位置*/'),
    (r'/\*锟斤拷锟斤拷锟斤拷息锟揭碉拷锟斤拷锟斤拷息锟叫诧拷锟斤拷锟斤拷锟斤拷锟斤拷息锟斤拷位锟斤拷\*/', '/*在消息中找到位置消息中不包含位置消息的位置*/'),
    (r'/\*锟姐播锟斤拷息\*/', '/*广播消息*/'),
    (r'/\*锟酵伙拷锟剿规定 锟斤拷锟絫p锟斤拷锟斤拷为1锟斤拷为锟斤拷锟斤拷锟斤拷息 tp为2锟斤拷为锟斤拷始位锟斤拷锟斤拷息\*/', '/*客户端规定 如果tp字段为1，为聊天消息 tp为2，为初始位置消息*/'),
    (r'/\*锟斤拷锟矫革拷锟斤拷息锟斤拷锟斤拷锟斤拷锟较\*/', '/*设置位置消息的位置消息*/'),
    (r'/\*锟斤拷锟斤拷锟斤拷息\*/', '/*创建登出消息*/'),
    (r'/\*锟斤拷锟斤拷锟斤拷息\*/', '/*广播消息*/'),
]

# 修复UTF-8编码的中文（被错误显示）
utf8_fixes = [
    (r'/\*閫氳繃Redis璇诲彇濮撳悕鏂囦欢鐢熸垚闅忔満濮撳悕\*/', '/*通过Redis读取姓名文件生成随机姓名*/'),
    (r'std::cout << "\[GameRole\] 寮濮嬪垱寤篏ameRole', 'std::cout << "[GameRole] 开始创建GameRole'),
    (r'std::cerr << "\[GameRole\] 閿欒: NameGenerator', 'std::cerr << "[GameRole] 错误: NameGenerator'),
    (r'std::cout << "\[GameRole\] 鐢熸垚鐨勭敤鎴峰悕', 'std::cout << "[GameRole] 生成的用户名'),
    (r'/\*鐢熸垚鐜╁剁殑闅忔満鍒濆嬩綅缃\*/', '/*生成玩家的随机初始位置*/'),
    (r'// AOI涓栫晫鑼冨洿', '// AOI世界范围'),
    (r'// 楂樺害鑼冨洿', '// 高度范围'),
    (r'// 鍒濆嬮熷害', '// 初始速度'),
    (r'std::cout << "\[GameRole\] 鐢熸垚闅忔満浣嶇疆', 'std::cout << "[GameRole] 生成随机位置'),
]

def fix_file(filepath):
    """修复单个文件"""
    if not os.path.exists(filepath):
        return False
    
    try:
        with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
            content = f.read()
        
        original = content
        
        # 应用所有修复
        for pattern, replacement in game_role_fixes + utf8_fixes:
            content = re.sub(pattern, replacement, content)
        
        if content != original:
            with open(filepath, 'w', encoding='utf-8') as f:
                f.write(content)
            print(f"✓ 已修复: {filepath}")
            return True
        else:
            print(f"- 无需修复: {filepath}")
            return False
    except Exception as e:
        print(f"✗ 错误 {filepath}: {e}")
        return False

def main():
    files = [
        'GameServer/GameRole.cpp',
        'GameServer/GameProtocol.cpp',
        'GameServer/GameChannel.cpp',
        'GameServer/GameMsg.cpp',
        'GameServer/AOI.cpp',
        'GameServer/AOI.h',
    ]
    
    print("开始修复乱码注释...\n")
    fixed = 0
    for f in files:
        if fix_file(f):
            fixed += 1
    
    print(f"\n完成! 修复了 {fixed} 个文件")

if __name__ == '__main__':
    main()

