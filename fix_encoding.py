#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
批量修复文件编码和乱码注释
将GBK编码的文件转换为UTF-8，并修复乱码注释
"""

import os
import sys
import chardet
import re

# 注释映射表（根据代码逻辑推断的正确注释）
COMMENT_MAP = {
    # GameRole.cpp
    r'/\*Լ200Ϣ\*/': '/*给自己发送对方的200消息*/',
    r'/\*ҷԼ200Ϣ\*/': '/*给对方发送自己的200消息*/',
    r'/\*Լ201Ϣ\*/': '/*给自己发送对方的201消息*/',
    r'/\*ҷԼ201Ϣ\*/': '/*给对方发送自己的201消息*/',
    r'/\*һ£Ϊtest\*/': '/*初始化一下，将用户名设置为test（已废弃，现在使用随机姓名）*/',
    r'/\*ҵĳʼλ\*/': '/*设置玩家的初始位置*/',
    r'/\*ͨͨidΨһ\*/': '/*通过协议通道的id作为唯一标识*/',
    r'/\*ҵϷ\*/': '/*将玩家添加到游戏世界*/',
    r'/\*ûʱҪûϢ ID\*/': '/*用户登录时需要给用户发送登录信息：ID 名字*/',
    r'/\*ûߺҪ䷢ΧҵϢ\*/': '/*用户上线后需要给他发送周围玩家的信息*/',
    r'/\*Χҷ͸Լλ\*/': '/*给周围玩家发送自己的位置*/',
    r'/\*ʽϢ\*/': '/*格式化消息*/',
    r'/\*ȡϢ\*/': '/*获取消息*/',
    r'/\*Ϣ\*/': '/*处理聊天内容消息*/',
    r'/\*ȡ\*/': '/*获取聊天内容*/',
    r'/\*ȡ\*/': '/*获取所有在线玩家*/',
    r'/\*ҷϢ\*/': '/*给玩家发送消息*/',
    r'/\*ƶϢ\*/': '/*处理玩家移动消息*/',
    r'/\*ڵͼеλ\*/': '/*获取玩家在地图世界中的位置*/',
    r'/\*ժɸ,,¸ӣȡھs2\*/': '/*摘掉旧格子，更新位置，加入新格子，获取新邻居s2*/',
    r'/\*s2Ԫزs1, Ұ\*/': '/*遍历s2中元素不在s1中，视野出现*/',
    r'//Ұ': '//视野出现',
    r'/\*s1Ԫزs2Ұʧ\*/': '/*遍历s1中元素不在s2中，视野消失*/',
    r'//Ұʧ': '//视野消失',
    r'/\*ΧҷϢ\*/': '/*给周围玩家发送位置信息*/',
    r'/\*ҷϢ\*/': '/*给周围玩家发送位置信息*/',
    r'/\*Ҫ͵ı\*/': '/*获取要发送的位置*/',
    r'/\*ظϢָ\*/': '/*设置位置消息的指针*/',
    r'/\*Ϣ\*/': '/*发送消息*/',
    r'/\*ڶӿժʱʹ\*/': '/*在通道接口摘除时会被使用*/',
    r'/\*Χҷ͸ߵϢ\*/': '/*给周围玩家发送该玩家下线的消息*/',
    r'/\*ҵ¼Ϣ\*/': '/*创建玩家登录消息*/',
    r'/\*䷢ΧҵϢ\*/': '/*发送给周围玩家的信息*/',
    r'/\*ΧǵϢ\*/': '/*周围玩家的信息*/',
    r'/\*Χ\*/': '/*获取周围玩家*/',
    r'/\*ΧҵϢsurplayers,ָϢָ\*/': '/*添加周围玩家的信息到surplayers中，添加指针指向消息的指针*/',
    r'/\*singleǸͣҪǿת\*/': '/*single指向的是Player类型，所以需要强制转换为GameRole*/',
    r'/\*ϢϢ\*/': '/*设置玩家消息的信息*/',
    r'/\*ϢʾΧҵλ\*/': '/*消息中显示周围玩家的位置*/',
    r'/\*ϢҵϢвϢλ\*/': '/*在消息中找到位置消息中不包含位置消息的位置*/',
    r'/\*㲥Ϣ\*/': '/*广播消息*/',
    r'/\*ͻ˹涨 tpΪ1ΪϢ tpΪ2ΪʼλϢ\*/': '/*客户端规定 如果tp字段为1，为聊天消息 tp为2，为初始位置消息*/',
    r'/\*øϢϢ\*/': '/*设置位置消息的位置消息*/',
    r'/\*Ϣ\*/': '/*创建登出消息*/',
    r'/\*Ϣ\*/': '/*广播消息*/',
    
    # AOI.cpp
    r'/\*ʼ\*/': '/*初始化*/',
    r'/\*\*/': '/*创建格子*/',
    r'/\*\*/': '/*添加玩家*/',
    r'/\*λ\*/': '/*计算玩家位置*/',
    r'/\*ҼAOIWorld\*/': '/*将玩家加入AOIWorld中*/',
    r'/\*ɾ\*/': '/*删除玩家*/',
    r'/\*ʾΧ\*/': '/*显示周围玩家*/',
    r'/\*ڵĸ\*/': '/*计算玩家所在的格子*/',
    r'/\*ڸӵxĸӵyӵ\*/': '/*计算玩家在格子的x的格子的索引和y格子的索引*/',
    r'/\*жϸǷλ磺Ͻǣ½ǣϽǣ½\*/': '/*判断格子是否在合法位置，例如：左上角，左下角，右上角，右下角*/',
    r'/\*øӵϽǺϷ\*/': '/*用格子的左上角是合法的*/',
    r'/\*ȡΧ Ұҷһlist\*/': '/*获取周围玩家 并且将他们放入一个list中*/',
    r'/\*ͷϵĸǺϷ\*/': '/*头顶上的格子是合法的*/',
    r'/\*ϽǸǺϷ\*/': '/*右上角格子是合法的*/',
    r'/\*ߵĸǺϷ\*/': '/*左边的格子是合法的*/',
    r'/\*ĸǺϷ\*/': '/*当前所在的格子是合法的*/',
    r'/\*ұߵĸǺϷ\*/': '/*当前右边的格子是合法的*/',
    r'/\*½ǵĸǺϷ\*/': '/*左下角格子是合法的*/',
    r'/\*·ĸǺϷ\*/': '/*当前下方的格子是合法的*/',
    r'/\*½ǵĸǺϷ\*/': '/*右下角格子是合法的*/',
    
    # GameChannel.cpp
    r'/\*һ\*/': '/*返回下一个处理阶段*/',
    r'/\*ͨ\*/': '/*创建通道对象*/',
    r'/\*ͨЭ\*/': '/*创建通道对应的协议对象*/',
    r'/\*Ҷ\*/': '/*创建玩家对象*/',
    r'/\*ͨЭ\*/': '/*通道绑定协议对象*/',
    r'/\*ЭҲͨ\*/': '/*协议对象也绑定通道*/',
    r'/\*RoleЭ\*/': '/*Role对象绑定协议对象*/',
    r'/\*ЭRole\*/': '/*协议对象绑定Role对象*/',
    r'/\*Э\*/': '/*将协议对象添加到框架*/',
    r'/\*Ҷ\*/': '/*将玩家对象添加到框架*/',
    
    # GameProtocol.cpp
    r'/\*תϢMultMsg\*/': '/*原始转换为请求的消息，返回MultMsg*/',
    r'/\*ǰĸֽ ĵֽڷֱ Ϣ ϢID\*/': '/*前四个字节 后四个字节分别是 消息长度 消息ID*/',
    r'/\*ͣĴ\*/': '/*持续的处理数据*/',
    r'/\*˴δֽ<8ôֱӵһݵٴ\*/': '/*如果此次待处理的字节数<8那么直接等待下一次数据到来再处理*/',
    r'/\*ǰĸֽ\*/': '/*读取前四个字节*/',
    r'/\*48ֽ\*/': '/*读取4到8的字节*/',
    r'/\*жϺĳǷϷ\*/': '/*判断后面剩余的长度是否合法*/',
    r'/\*Ϸ͵ȴһβ\*/': '/*不合法就等待下一次处理*/',
    r'/\*һû\*/': '/*创建一个用户消息*/',
    r'/\*Դɹı\*/': '/*删除已经处理成功的部分*/',
    r'/\*ҵ㣬͵ݣתַ\*/': '/*响应发送到业务层，将发送的数据，转换为字符串*/',
    r'/\*Ҫ͵ı\*/': '/*要发送的变量长度*/',
    r'/\*ʼ\*/': '/*开始赋值*/',
    r'/\*ǰ4ֽڷųϢ,ֽǰֽں\*/': '/*前4个字节存放长度消息，低字节在前高字节在后*/',
    r'/\*5ֽڵ8ֽ\*/': '/*接下来5个字节到8个字节*/',
    r'/\*ƴӵ7ֽԺ\*/': '/*拼接到第7个字节以后的内容*/',
    r'/\*ٷظ\*/': '/*返回业务层对象，返回该对象*/',
    r'/\*ݷ͵ͨ\*/': '/*将数据发送到通道*/',
    r'/\*ͨ\*/': '/*返回通道对象*/',
    
    # GameMsg.cpp
    r'/\*ͨϢϢ\*/': '/*通过消息类型创建消息对象*/',
    r'/\*ɶ  ba_streampmsg\*/': '/*通过protobuf解析成对象 把_stream传给pmsg*/',
}

def detect_encoding(file_path):
    """检测文件编码"""
    with open(file_path, 'rb') as f:
        raw_data = f.read()
        result = chardet.detect(raw_data)
        return result['encoding']

def convert_file(file_path):
    """转换单个文件"""
    try:
        # 检测编码
        encoding = detect_encoding(file_path)
        if encoding is None:
            encoding = 'utf-8'
        
        # 读取文件
        with open(file_path, 'r', encoding=encoding, errors='ignore') as f:
            content = f.read()
        
        # 替换乱码注释
        original_content = content
        for pattern, replacement in COMMENT_MAP.items():
            content = re.sub(pattern, replacement, content)
        
        # 如果内容有变化，写回文件
        if content != original_content:
            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(content)
            print(f"✓ 已修复: {file_path}")
            return True
        else:
            print(f"- 无需修复: {file_path}")
            return False
    except Exception as e:
        print(f"✗ 错误 {file_path}: {e}")
        return False

def main():
    """主函数"""
    game_server_dir = 'GameServer'
    
    if not os.path.exists(game_server_dir):
        print(f"错误: 找不到目录 {game_server_dir}")
        return
    
    # 获取所有C++源文件
    files = []
    for ext in ['*.cpp', '*.h', '*.cc']:
        import glob
        files.extend(glob.glob(os.path.join(game_server_dir, ext)))
    
    print(f"找到 {len(files)} 个文件")
    print("开始修复编码和注释...\n")
    
    fixed_count = 0
    for file_path in files:
        if convert_file(file_path):
            fixed_count += 1
    
    print(f"\n完成! 修复了 {fixed_count} 个文件")

if __name__ == '__main__':
    main()

